---
title: "Baserunner Speed Calculations"
author: "Ryan Dajani"
date: "2024-06-21"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analyzing Caught Stealing Percentage of different runners

##Load in libraries

```{r, warning=FALSE}
#install.packages(c("tidyverse", "arrow", "gt"))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(arrow))
library(gt)
library(dplyr)
```

# filter the player_positions data set to include plays by runners on first and second base
```{r}
steal_info <- filtered_player_pos %>%
  inner_join(filter_steals, by=c("game_str", "play_id"))

run_on_first_info <- steal_info %>%
  filter(player_position == 11)

unique_run_on_first_info <- c(unique(run_on_first_info$game_str))
type(unique_run_on_first_info)

run_on_second_info <- steal_info %>%
  filter(player_position == 12)


View(unique_run_on_first_info)


```

```{r}
#speed = distance/time
#speed*time = distance
#time = distance/speed
speed_calc_first <- function(game_string, play, position) {
  
  filtered_steal_info_copy <- run_on_first_info %>%
    filter(game_str == game_string) %>%
    filter(play_id == play) %>%
    filter(player_position == position)
  
  n <- nrow(filtered_steal_info_copy)
  speed_vector <- numeric(n)
  acceleration_vector <- numeric(n)
  
  for (i in 2:n) {
    
    row_a <- filtered_steal_info_copy[i, ]
    row_b <- filtered_steal_info_copy[i - 1, ]
    if (any(is.na(row_a)) || any(is.na(row_b)) || length(speed_vector) <= 0){
      next
    }
    
    # print(paste("Row A: ", row_a))
    # print(paste("Row B: ", row_b))
    
    delta_time <- row_a$timestamp - row_b$timestamp
    
    #print(paste("Delta Time: ", delta_time))
    
    delta_x <- row_a$field_x - row_b$field_x
    delta_y <- row_a$field_y - row_b$field_y
    
    velocity_x <- delta_x / delta_time
    velocity_y <- delta_y / delta_time
    
    distance <- sqrt(delta_x^2 + delta_y^2)
    
    speed <- distance / delta_time
    
    speed_vector[i] <- speed
    # print(paste("speed vector length:  ", length (speed_vector)))
    
    
    if (!is.na(speed_vector[i - 1])) {
      acceleration_vector[i] <- speed_vector[i] - speed_vector[i - 1]
    }
  }
  
  filtered_steal_info_copy <- filtered_steal_info_copy %>%
    mutate(player_speed = speed_vector,
           acceleration = acceleration_vector)
  
  max_speed <- max(filtered_steal_info_copy$player_speed, na.rm = TRUE)
  
  max_speed_index <- which.max(filtered_steal_info_copy$player_speed)
  
  time_at_top_speed <- filtered_steal_info_copy$timestamp[max_speed_index]
  
  
  filtered_data <- filtered_steal_info_copy %>%
    filter(timestamp >= (time_at_top_speed - 2000) & timestamp <= (time_at_top_speed + 2000))
  
  #print(paste("Length of max speed: ", length(max_speed)))
  return (max_speed)
  # print(game_string)
  # print(play)
  # print(speed_vector)
  # print(position)
  # print(max_speed)
}

speed_calc_first("1884_143_Vis4BE_Home4A",251, 11)
```

```{r}
#speed = distance/time
#speed*time = distance
#time = distance/speed
speed_calc_second <- function(game_string, play, position) {
  filtered_steal_info_copy <- run_on_second_info %>%
    filter(game_str == game_string) %>%
    filter(play_id == play) %>%
    filter(player_position == position)
  
  n <- nrow(filtered_steal_info_copy)
  speed_vector <- numeric(n)
  acceleration_vector <- numeric(n)
  
  for (i in 2:n) {
    # print(paste("index: ", i))
    # print(paste("Game String: ", game_string))
    # print(paste("Play ID: ", play))
    
    row_a <- filtered_steal_info_copy[i, ]
    row_b <- filtered_steal_info_copy[i - 1, ]
    if (is.na(row_a) || is.na(row_b)){
      next
    }
    
    # print(paste("Row A: ", row_a))
    # print(paste("Row B: ", row_b))
    
    delta_time <- row_a$timestamp - row_b$timestamp
    
    #print(paste("Delta Time: ", delta_time))
    
    delta_x <- row_a$field_x - row_b$field_x
    delta_y <- row_a$field_y - row_b$field_y
    
    velocity_x <- delta_x / delta_time
    velocity_y <- delta_y / delta_time
    
    distance <- sqrt(delta_x^2 + delta_y^2)
    
    speed <- distance / delta_time
    
    speed_vector[i] <- speed
    #print(paste("speed vector length:  ", length (speed_vector)))
    
    
    if (!is.na(speed_vector[i - 1])) {
      acceleration_vector[i] <- speed_vector[i] - speed_vector[i - 1]
    }
  }
  
  filtered_steal_info_copy <- filtered_steal_info_copy %>%
    mutate(player_speed = speed_vector,
           acceleration = acceleration_vector)
  
  max_speed <- max(filtered_steal_info_copy$player_speed, na.rm = TRUE)
  
  max_speed_index <- which.max(filtered_steal_info_copy$player_speed)
  
  time_at_top_speed <- filtered_steal_info_copy$timestamp[max_speed_index]
  
  
  filtered_data <- filtered_steal_info_copy %>%
    filter(timestamp >= (time_at_top_speed - 2000) & timestamp <= (time_at_top_speed + 2000))
  
  #print(paste("Length of max speed: ", length(max_speed)))
  return (max_speed)
  # print(game_string)
  # print(play)
  # print(speed_vector)
  # print(position)
  # print(max_speed)
}
```


```{r}
first_max_speed_vector <- c()
second_max_speed_vector <- c()

for(i in 1:nrow(filter_steals)){
  #print(paste("Play ID: : ", filter_steals$play_id))
  
  first_max_speed_vector <- c(first_max_speed_vector, speed_calc_first(filter_steals$game_str[i], filter_steals$play_id[i], 11))
  #second_max_speed_vector <- c(second_max_speed_vector, speed_calc_second(filter_steals$game_str[i], filter_steals$play_id[i], 12))
}
print(first_max_speed_vector)
```