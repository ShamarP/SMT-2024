---
title: "Baserunner Speed Calculations"
author: "Ryan Dajani"
date: "2024-06-21"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analyzing Caught Stealing Percentage of different runners

##Load in libraries

```{r, warning=FALSE}
#install.packages(c("tidyverse", "arrow", "gt"))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(arrow))
library(gt)
library(dplyr)
```

# filter the player_positions data set to include plays by runners on first and second base
```{r}
steal_info <- filtered_player_pos %>%
  inner_join(filter_steals, by=c("game_str", "play_id"))

steal_info_copy <- steal_info %>%
  filter(player_position == 11 | player_position == 12)
run_on_first_info <- steal_info %>%
  filter(player_position == 11)

run_on_second_info <- steal_info %>%
  filter(player_position == 12)

```
#function to get each first baserunner's max speed for plays where a steal was successful 
```{r}
speed_calc_first <- function(game_string, play, position) {
  
  filtered_steal_info_copy <- run_on_first_info %>%
    filter(game_str == game_string) %>%
    filter(play_id == play) %>%
    filter(player_position  == position)
  
  
  n <- nrow(filtered_steal_info_copy)
  speed_vector <- numeric(n)
  acceleration_vector <- numeric(n)

  for (i in 2:n) {
    
    row_a <- filtered_steal_info_copy[i, ]
    row_b <- filtered_steal_info_copy[i - 1, ]
    if (any(is.na(row_a)) || any(is.na(row_b)) || length(speed_vector) <= 0){
      next
    }
    
    delta_time <- (row_a$timestamp - row_b$timestamp)/1000
    
    delta_x <- row_a$field_x - row_b$field_x
    delta_y <- row_a$field_y - row_b$field_y
    
    velocity_x <- delta_x / delta_time
    velocity_y <- delta_y / delta_time
    
    speed <- sqrt(velocity_x^2 + velocity_y^2)
    if(speed > 32){
      speed_vector[i] <- NA
    }else{
      speed_vector[i] <- speed
    }
    
    if (!is.na(speed_vector[i - 1])) {
      acceleration_vector[i] <- speed_vector[i] - speed_vector[i - 1]
    }
  }
  
  filtered_steal_info_copy <- filtered_steal_info_copy %>%
    mutate(player_speed = speed_vector,
           acceleration = acceleration_vector)
    
  max_speed <- max(filtered_steal_info_copy$player_speed, na.rm = TRUE)
  
  return (max_speed)
}

speed_calc_first("1883_019_Vis4AF_Home4A", 27, 11)
```
#function to get each second baserunners's max speed for plays where a steal was successful 
```{r}
speed_calc_second <- function(game_string, play, position) {
  
  #filtering out the run_on_second_info dataframe such that
  #the game_str inside of the run_on_second_info dataframe matches the 
  second_steal_info_copy <- run_on_second_info %>%
    filter(game_str == game_string) %>%
    filter(play_id == play) %>%
    filter(player_position == position)

  #stores the number of rows inside of second_steal_info_copy 
  second_n <- nrow(second_steal_info_copy)
  #creating a numeric vector of size second n that would hold all of the speed values
  second_speed_vector <- numeric(second_n)
  #creating a numeric vector of size second_n to hold all of the acceleration values
  second_acceleration_vector <- numeric(second_n)
  
  for (j in 2:second_n) {

    second_row_a <- second_steal_info_copy[j, ]
    second_row_b <- second_steal_info_copy[j - 1, ]
     if (any(is.na(second_row_a)) || any(is.na(second_row_b)) || length(second_speed_vector) <= 0){
      next
    }
    
    second_delta_time <- (second_row_a$timestamp - second_row_b$timestamp)/1000
    
    second_delta_x <- second_row_a$field_x - second_row_b$field_x
    second_delta_y <- second_row_a$field_y - second_row_b$field_y
    
    second_velocity_x <- second_delta_x / second_delta_time
    second_velocity_y <- second_delta_y / second_delta_time
    
    second_speed <- sqrt(second_velocity_x^2 + second_velocity_y^2)
    
    if(second_speed > 32){
      second_speed_vector[j] <- NA
    }else{
      second_speed_vector[j] <- second_speed
      
    }
    
    if (!is.na(second_speed_vector[j - 1])) {
      second_acceleration_vector[j] <- second_speed_vector[j] - second_speed_vector[j - 1]
    }
  }
  
  second_steal_info_copy <- second_steal_info_copy %>%
    mutate(second_player_speed = second_speed_vector,
           second_acceleration = second_acceleration_vector)
  
  second_max_speed <- max(second_steal_info_copy$second_player_speed, na.rm = TRUE)
  return (second_max_speed)

}
speed_calc_second("1883_019_Vis4AF_Home4A", 27, 12)
```
#Function to get the level that a player played in
```{r}

get_player_level <- function(game_string){
  
  # #getting the minor league level that the game was played in 
  player_level <- substr(game_string, nchar(game_string)-1, nchar(game_string) -1)
  player_level <- as.integer(player_level)
  
  return(player_level)
}
```
#function to get player cauught stealing percentage
```{r}

get_caught_stealing_pct <- function(game_string, play, player_id){
  
  player_filter <- pre_steal %>%
    filter(game_str == game_string) %>%
    filter(play_id == play) %>%
    filter(first_baserunner.x == player_id | second_baserunner.x == player_id | first_baserunner.y == player_id | second_baserunner.y == player_id)
  
  
  player_success_steal <- player_filter %>%
    filter(valid_steal == 1)
  
  player_fail_steal <- player_filter %>%
    filter(valid_steal == 0)
  
  player_steal_pct <- (length(player_success_steal) / (length(player_success_steal) + length(player_fail_steal))) * 100
  
  return(player_steal_pct)
  
}

get_caught_stealing_pct("1883_001_Vis4AB_Home4A", 96, 4875)
```


#creating a dataframe that has each players Level, Max Speed and Player ID. 
```{r}
steal_filtered_game_info <- inner_join(filtered_game_info, steal_plays, by=c("game_str" = "game_str",  "play_id" = "play_per_game"))

result <- merge(avg_pitch_velo_adj, steal_filtered_game_info)

speed_result <- merge(filter_steals, steal_filtered_game_info)
speed_result_copy <- merge(speed_result, steal_info)

fb_speed_result_copy <- speed_result_copy %>%
  filter(player_position == 11)

fb_speed_result_copy <- fb_speed_result_copy %>%
  distinct(play_id, .keep_all = TRUE)

sb_speed_result_copy <- speed_result_copy %>%
  filter(player_position == 12)

sb_speed_result_copy <- sb_speed_result_copy %>%
  distinct(play_id, .keep_all = TRUE)

first_max_speed_vector <- c()
first_level_vector <- c()

second_max_speed_vector <- c()
second_level_vector <- c()

first_steal_pct_vector <- c()
second_steal_pct_vector <- c()


for (j in 1:nrow(sb_speed_result_copy)){
  second_max_speed_vector <- c(second_max_speed_vector, speed_calc_second(sb_speed_result_copy$game_str[j], sb_speed_result_copy$play_id[j], 12))
  
  second_level_vector <- c(second_level_vector, get_player_level(sb_speed_result_copy$game_str))
  
  second_steal_pct_vector <- c(player_steal_pct_vector, get_caught_stealing_pct(sb_speed_result_copy$game_str[j], sb_speed_result_copy$play_id[j], sb_speed_result_copy$second_baserunner[j]))
}


for(i in 1:nrow(fb_speed_result_copy)){
  first_max_speed_vector  <- c(first_max_speed_vector, speed_calc_first(fb_speed_result_copy$game_str[i], fb_speed_result_copy$play_id[i], 11))
  
  first_level_vector <- c(first_level_vector, get_player_level(fb_speed_result_copy$game_str))
}

first_max_speed_df <- data.frame(
  "Max Speed" = first_max_speed_vector,
  "Player ID" = fb_speed_result_copy$first_baserunner,
  "Player Level" = first_level_vector,
)

View(first_max_speed_df)

second_max_speed_df <- data.frame(
  "Max Speed" = second_max_speed_vector,
  "Player ID" = sb_speed_result_copy$second_baserunner,
  "Player Level" = second_level_vector
) 

combined_max_speed_df <- rbind(first_max_speed_df, second_max_speed_df)

combined_max_speed_df <- combined_max_speed_df %>%
  rbind(mean(combined_max_speed_df$Max.Speed))

```
#separating the combined dataframes into dataframes for each level
```{r}

level_one_max_speed_df <- combined_max_speed_df %>%
  group_by(Player.Level) %>%
  filter(Player.Level == 1) %>%
  ungroup()
level_two_max_speed_df <- combined_max_speed_df %>%
  group_by(Player.Level) %>%
  filter(Player.Level == 2) %>%
  ungroup()
level_three_max_speed_df <- combined_max_speed_df %>%
  group_by(Player.Level) %>%
  filter(Player.Level == 3) %>%
  ungroup()
level_four_max_speed_df <- combined_max_speed_df %>%
  group_by(Player.Level) %>%
  filter(Player.Level == 4) %>%
  ungroup()

```
#creating tables ranking player max speed overall
```{r}
library(dplyr)
library(ggplot2)
library(gt)

fastest_runners <- combined_max_speed_df %>%
  group_by(Player.ID, Player.Level) %>%
  summarize(MaxSpeed = max(Max.Speed)) %>%
  ungroup() %>%
  arrange(desc(MaxSpeed)) %>%
  mutate(Rank = row_number())%>%
  slice_head(n = 10)

top_runners_table <- fastest_runners %>%
  gt() %>%
  tab_header(
    title = "Top 10 Basrunners by Maximum run speed"
  )%>%
  cols_label(
    Player.ID = "Runner ID",
    MaxSpeed = "Maximum Run Speed (ft/s)",
    Rank = "Rank",
    Player.Level = "Minor League Level"
  )%>%
  tab_options(
    table.font.size = 12
  )
top_runners_table
```

#Creating a Table to Rank top 10 fastest Players in Rookie Ball
```{r}
level_one_fastest_runners <- level_one_max_speed_df %>%
  group_by(Player.ID) %>%
  summarize(MaxSpeed = max(Max.Speed)) %>%
  ungroup() %>%
  arrange(desc(MaxSpeed)) %>%
  mutate(Rank = row_number())%>%
  slice_head(n = 10)

level_one_top_runners_table <- level_one_fastest_runners %>%
  gt() %>%
  tab_header(
    title = "Top 10 Basrunners by Maximum run speed in Rookie Ball"
  )%>%
  cols_label(
    Player.ID = "Runner ID",
    MaxSpeed = "Maximum Run Speed (ft/s)",
    Rank = "Rank"
  )%>%
  tab_options(
    table.font.size = 12
  )
level_one_top_runners_table
```

```{r}
level_two_fastest_runners <- level_two_max_speed_df %>%
  group_by(Player.ID) %>%
  summarize(MaxSpeed = max(Max.Speed)) %>%
  ungroup() %>%
  arrange(desc(MaxSpeed)) %>%
  mutate(Rank = row_number())%>%
  slice_head(n = 10)

level_two_top_runners_table <- level_two_fastest_runners %>%
  gt() %>%
  tab_header(
    title = "Top 10 Basrunners by Maximum run speed in High A"
  )%>%
  cols_label(
    Player.ID = "Runner ID",
    MaxSpeed = "Maximum Run Speed (ft/s)",
    Rank = "Rank"
  )%>%
  tab_options(
    table.font.size = 12
  )
level_two_top_runners_table
```

#Creating a Table Showcase top 10 Fastest players in Double A
```{r}
level_three_fastest_runners <- level_three_max_speed_df %>%
  group_by(Player.ID) %>%
  summarize(MaxSpeed = max(Max.Speed)) %>%
  ungroup() %>%
  arrange(desc(MaxSpeed)) %>%
  mutate(Rank = row_number())%>%
  slice_head(n = 10)

level_three_top_runners_table <- level_three_fastest_runners %>%
  gt() %>%
  tab_header(
    title = "Top 10 Basrunners by Maximum run speed in Double A"
  )%>%
  cols_label(
    Player.ID = "Runner ID",
    MaxSpeed = "Maximum Run Speed (ft/s)",
    Rank = "Rank"
  )%>%
  tab_options(
    table.font.size = 12
  )
level_three_top_runners_table
```
#Creating a Table Showcase top 10 Fastest players in Triple A
```{r}
level_four_fastest_runners <- level_four_max_speed_df %>%
  group_by(Player.ID) %>%
  summarize(MaxSpeed = max(Max.Speed)) %>%
  ungroup() %>%
  arrange(desc(MaxSpeed)) %>%
  mutate(Rank = row_number())%>%
  slice_head(n = 10)

level_four_top_runners_table <- level_four_fastest_runners %>%
  gt() %>%
  tab_header(
    title = "Top 10 Basrunners by Maximum run speed in Triple A"
  )%>%
  cols_label(
    Player.ID = "Runner ID",
    MaxSpeed = "Maximum Run Speed (ft/s)",
    Rank = "Rank"
  )%>%
  tab_options(
    table.font.size = 12
  )
level_four_top_runners_table
```